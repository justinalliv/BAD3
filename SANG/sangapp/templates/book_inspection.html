{% extends 'base.html' %}

{% block title %}Book Inspection - SANG Pest Control{% endblock %}

{% block extra_css %}
    .main-content {
        max-width: 620px;
        margin: 40px auto;
        padding: 0 24px;
    }

    .section {
        background: transparent;
        border-radius: 0;
        padding: 0;
        box-shadow: none;
    }

    .page-header h1 {
        color: #1a2a5e;
        font-size: 3em;
        text-align: center;
        margin-bottom: 26px;
    }

    .form-card h1 {
        color: #1a2a5e;
        font-size: 2em;
        margin-bottom: 30px;
        text-align: center;
    }

    .form-group label .required {
        color: red;
    }

    .form-group label {
        font-weight: 600;
    }

    .form-group .error {
        color: red;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .form-group small {
        display: block;
        margin-top: 0.25rem;
        color: #666;
        font-size: 0.875rem;
    }

    .hidden {
        display: none;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-row.full {
        grid-template-columns: 1fr;
    }

    .form-group input,
    .form-group select,
    .form-row input,
    .form-row select {
        min-height: 46px;
    }

    .button-group {
        justify-content: center;
        margin-top: 34px;
    }

    .button-group .btn {
        min-width: 180px;
    }

    .success-container {
        text-align: center;
        padding: 40px 20px;
    }

    .success-icon {
        width: 60px;
        height: 60px;
        background-color: #28a745;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0 auto 20px;
        color: white;
        font-size: 2em;
        font-weight: bold;
    }

    .success-icon::before {
        content: "âœ“";
    }

    .success-container h2 {
        color: #1a2a5e;
        margin-bottom: 15px;
        font-size: 1.5em;
    }

    .success-container p {
        color: #333;
        font-size: 1em;
        line-height: 1.6;
        margin-bottom: 10px;
    }

    .service-id {
        font-size: 1.5rem;
        font-weight: bold;
        color: #1a2a5e;
        margin: 1rem 0 2rem 0;
    }
{% endblock %}

{% block base_nav %}
<nav class="nav-spacious">
        <div class="nav-logo">
            <svg width="40" height="40" viewBox="0 0 40 40" style="fill: #1a2a5e;">
                <circle cx="20" cy="10" r="4"/>
                <path d="M 20 14 Q 15 18 20 26 Q 25 18 20 14 Z"/>
                <circle cx="15" cy="22" r="1.5"/>
                <circle cx="25" cy="22" r="1.5"/>
            </svg>
            <span class="nav-logo-text">Supreme</span>
        </div>

        <ul class="nav-links">
            <li><a href="{% url 'customer_home' %}">Home</a></li>
            <li><a href="{% url 'book_inspection' %}" class="active">Book Inspection</a></li>
            <li><a href="{% url 'property_list' %}">Manage Properties</a></li>
            <li><a href="{% url 'service_status' %}">Service Status</a></li>
        </ul>

        <a href="{% url 'profile' %}" class="profile-btn">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <circle cx="10" cy="6" r="4"/>
                <path d="M 4 18 Q 4 12 10 12 Q 16 12 16 18 Z"/>
            </svg>
            Profile
        </a>
    </nav>
{% endblock %}

{% block content %}
    <!-- Navigation -->
    

    <!-- Main Content -->
    <div class="main-content">
        {% if success %}
        <!-- Success State -->
        <div class="section">
            <div class="success-container">
                <div class="success-icon"></div>
                <h2>Booking Successful!</h2>
                <p>You have successfully booked a site inspection.</p>
                <p class="service-id">Service ID: {{ service_id }}</p>
                <a href="{% url 'profile' %}" class="btn btn-primary">View Service Status</a>
            </div>
        </div>
        {% else %}
        <!-- Form -->
        <div class="section">
            <div class="page-header">
                <h1>Book Inspection</h1>
            </div>

            <form id="bookingForm" method="POST">
                {% csrf_token %}
                
                <!-- Property Selection -->
                <div class="form-group">
                    <label for="property_id">Property Address <span class="required">*</span></label>
                    <select name="property_id" id="property_id" required>
                        <option value="">Select a property</option>
                        {% for property in properties %}
                        <option value="{{ property.id }}" 
                                data-type="{{ property.property_type }}"
                                data-floor="{{ property.floor_area }}"
                                {% if form_data.property_id == property.id|stringformat:"s" %}selected{% endif %}>
                            {{ property.property_name }} - {{ property.street_number }} {{ property.street }}, {{ property.city }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if errors.property_id %}
                    <div class="error">{{ errors.property_id }}</div>
                    {% endif %}
                </div>

                <!-- Property Details (Auto-filled) -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="property_type">Type of Property</label>
                        <input type="text" id="property_type" disabled placeholder="Select a property first">
                    </div>
                    <div class="form-group">
                        <label for="floor_area">Floor Area (sq m)</label>
                        <input type="text" id="floor_area" disabled placeholder="Select a property first">
                    </div>
                </div>

                <!-- Preferred Service -->
                <div class="form-group">
                    <label for="preferred_service">Preferred Service <span class="required">*</span></label>
                    <select name="preferred_service" id="preferred_service" required>
                        <option value="">Select a service</option>
                        {% for choice in service_choices %}
                        <option value="{{ choice.0 }}" {% if form_data.preferred_service == choice.0 %}selected{% endif %}>
                            {{ choice.1 }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if errors.preferred_service %}
                    <div class="error">{{ errors.preferred_service }}</div>
                    {% endif %}
                </div>

                <!-- Other Service (Hidden by default) -->
                <div class="form-group hidden" id="other_service_group">
                    <label for="preferred_service_other">Please specify service <span class="required">*</span></label>
                    <input type="text" name="preferred_service_other" id="preferred_service_other" 
                           placeholder="Enter service type" value="{{ form_data.preferred_service_other }}">
                    {% if errors.preferred_service_other %}
                    <div class="error">{{ errors.preferred_service_other }}</div>
                    {% endif %}
                </div>

                <!-- Pest Problem -->
                <div class="form-group">
                    <label for="pest_problem">Pest Problem <span class="required">*</span></label>
                    <select name="pest_problem" id="pest_problem" required>
                        <option value="">Select a pest problem</option>
                        {% for choice in pest_choices %}
                        <option value="{{ choice.0 }}" {% if form_data.pest_problem == choice.0 %}selected{% endif %}>
                            {{ choice.1 }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if errors.pest_problem %}
                    <div class="error">{{ errors.pest_problem }}</div>
                    {% endif %}
                </div>

                <!-- Other Pest Problem (Hidden by default) -->
                <div class="form-group hidden" id="other_pest_group">
                    <label for="pest_problem_other">Please specify pest problem <span class="required">*</span></label>
                    <input type="text" name="pest_problem_other" id="pest_problem_other" 
                           placeholder="Enter pest problem" value="{{ form_data.pest_problem_other }}">
                    {% if errors.pest_problem_other %}
                    <div class="error">{{ errors.pest_problem_other }}</div>
                    {% endif %}
                </div>

                <!-- Date and Time -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="date">Preferred Date <span class="required">*</span></label>
                        <input type="date" name="date" id="date" required 
                               min="{{ today }}" value="{{ form_data.date }}">
                        {% if errors.date %}
                        <div class="error">{{ errors.date }}</div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="time_slot">Time Slot <span class="required">*</span></label>
                        <select name="time_slot" id="time_slot" required disabled>
                            <option value="">Select date first</option>
                            {% for choice in time_slot_choices %}
                            <option value="{{ choice.0 }}" {% if form_data.time_slot == choice.0 %}selected{% endif %}>
                                {{ choice.1 }}
                            </option>
                            {% endfor %}
                        </select>
                        {% if errors.time_slot %}
                        <div class="error">{{ errors.time_slot }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Buttons -->
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmBtn">Confirm Booking</button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <h2>Confirm Booking</h2>
            <p>Are you sure you want to book this site inspection?</p>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" id="continueEditingBtn">Continue Editing</button>
                <button type="button" class="btn btn-primary" id="confirmSubmitBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Cancel Confirmation Modal -->
    <div class="modal" id="cancelModal">
        <div class="modal-content">
            <h2>Cancel Booking</h2>
            <p>Are you sure you want to cancel? All entered information will be lost.</p>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" id="keepEditingBtn">Keep Editing</button>
                <button type="button" class="btn btn-primary" id="confirmCancelBtn">Yes, Cancel</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
        // Get today's date for date picker minimum
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').setAttribute('min', today);

        // Property selection - auto-fill type and floor area
        document.getElementById('property_id').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const propertyType = selectedOption.getAttribute('data-type');
            const floorArea = selectedOption.getAttribute('data-floor');
            
            if (propertyType && floorArea) {
                document.getElementById('property_type').value = propertyType;
                document.getElementById('floor_area').value = floorArea;
            } else {
                document.getElementById('property_type').value = '';
                document.getElementById('floor_area').value = '';
            }
        });

        // Trigger change event on load if property is selected (for form errors)
        if (document.getElementById('property_id').value) {
            document.getElementById('property_id').dispatchEvent(new Event('change'));
        }

        // Preferred Service - show/hide "Other" field
        document.getElementById('preferred_service').addEventListener('change', function() {
            const otherGroup = document.getElementById('other_service_group');
            const otherInput = document.getElementById('preferred_service_other');
            
            if (this.value === 'Other') {
                otherGroup.classList.remove('hidden');
                otherInput.setAttribute('required', 'required');
            } else {
                otherGroup.classList.add('hidden');
                otherInput.removeAttribute('required');
                otherInput.value = '';
            }
        });

        // Trigger change event on load if "Other" is selected
        if (document.getElementById('preferred_service').value === 'Other') {
            document.getElementById('preferred_service').dispatchEvent(new Event('change'));
        }

        // Pest Problem - show/hide "Other" field
        document.getElementById('pest_problem').addEventListener('change', function() {
            const otherGroup = document.getElementById('other_pest_group');
            const otherInput = document.getElementById('pest_problem_other');
            
            if (this.value === 'Other') {
                otherGroup.classList.remove('hidden');
                otherInput.setAttribute('required', 'required');
            } else {
                otherGroup.classList.add('hidden');
                otherInput.removeAttribute('required');
                otherInput.value = '';
            }
        });

        // Trigger change event on load if "Other" is selected
        if (document.getElementById('pest_problem').value === 'Other') {
            document.getElementById('pest_problem').dispatchEvent(new Event('change'));
        }

        // Date selection - enable time slot
        document.getElementById('date').addEventListener('change', function() {
            const timeSlot = document.getElementById('time_slot');
            
            if (this.value) {
                timeSlot.disabled = false;
                timeSlot.innerHTML = '<option value="">Select a time slot</option>' + 
                    Array.from(timeSlot.options).slice(1).map(opt => opt.outerHTML).join('');
            } else {
                timeSlot.disabled = true;
                timeSlot.innerHTML = '<option value="">Select date first</option>';
            }
        });

        // Trigger change event on load if date is selected
        if (document.getElementById('date').value) {
            document.getElementById('date').dispatchEvent(new Event('change'));
        }

        // Confirm button - validate and show confirmation modal
        document.getElementById('confirmBtn').addEventListener('click', function() {
            const form = document.getElementById('bookingForm');
            
            // Check HTML5 validation
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Additional validation for "Other" fields
            const preferredService = document.getElementById('preferred_service').value;
            const preferredServiceOther = document.getElementById('preferred_service_other').value.trim();
            
            if (preferredService === 'Other' && !preferredServiceOther) {
                alert('Please specify the service type.');
                document.getElementById('preferred_service_other').focus();
                return;
            }

            const pestProblem = document.getElementById('pest_problem').value;
            const pestProblemOther = document.getElementById('pest_problem_other').value.trim();
            
            if (pestProblem === 'Other' && !pestProblemOther) {
                alert('Please specify the pest problem.');
                document.getElementById('pest_problem_other').focus();
                return;
            }

            // Show confirmation modal
            document.getElementById('confirmModal').classList.add('active');
        });

        // Continue Editing button in confirmation modal
        document.getElementById('continueEditingBtn').addEventListener('click', function() {
            document.getElementById('confirmModal').classList.remove('active');
        });

        // Confirm Submit button in confirmation modal
        document.getElementById('confirmSubmitBtn').addEventListener('click', function() {
            document.getElementById('bookingForm').submit();
        });

        // Cancel button - show cancel confirmation modal
        document.getElementById('cancelBtn').addEventListener('click', function() {
            document.getElementById('cancelModal').classList.add('active');
        });

        // Keep Editing button in cancel modal
        document.getElementById('keepEditingBtn').addEventListener('click', function() {
            document.getElementById('cancelModal').classList.remove('active');
        });

        // Confirm Cancel button - redirect to customer home
        document.getElementById('confirmCancelBtn').addEventListener('click', function() {
            window.location.href = "{% url 'customer_home' %}";
        });

        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
    </script>
{% endblock %}
