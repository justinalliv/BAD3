{% extends 'base.html' %}

{% block title %}Update Property - Supreme Biotech Solutions{% endblock %}

{% block extra_css %}
    .form-container {
        max-width: 560px;
        margin: 14px auto 18px;
        padding: 0 24px;
    }

    .form-card {
        background: transparent;
        border-radius: 0;
        padding: 0;
        box-shadow: none;
    }

    .form-card h1 {
        color: #1a2a5e;
        font-size: clamp(1.75rem, 3.8vh, 2.4rem);
        line-height: 1.1;
        margin-top: 30px;
        margin-bottom: 14px;
        text-align: center;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 8px;
    }

    .form-row > div {
        width: 100%;
    }

    .form-row.full {
        grid-template-columns: 1fr;
    }

    .error-message {
        color: #e74c3c;
        font-size: 0.85em;
        margin-top: 5px;
        display: block;
    }

    .form-group label,
    .form-row label {
        font-weight: 600;
        font-size: 0.96em;
        color: #4a4a4a;
        margin-bottom: 4px;
        display: block;
    }

    .property-address-title {
        color: #4a4a4a;
        font-weight: 600;
        font-size: 0.96em;
        margin: 2px 0 8px;
    }

    .form-group input,
    .form-group select,
    .form-row input,
    .form-row select {
        width: 100%;
        min-height: 46px;
        border: 1px solid #d6d6d6;
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 0.96em;
        color: #4a4a4a;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-row input:focus,
    .form-row select:focus {
        outline: none;
        border-color: #1a2a5e;
        box-shadow: 0 0 0 3px rgba(26, 42, 94, 0.12);
    }

    .form-group select,
    .form-row select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='10' viewBox='0 0 14 10'%3E%3Cpath fill='none' stroke='%234a4a4a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='M1 1l6 6 6-6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center;
        background-size: 14px 10px;
        padding-right: 42px;
    }

    .form-group input::placeholder,
    .form-row input::placeholder {
        color: #9a9a9a;
    }

    .button-group {
        justify-content: center;
        margin-top: 16px;
        gap: 10px;
    }

    .button-group .btn {
        min-width: 180px;
        min-height: 46px;
        border-radius: 12px;
        font-size: 0.96em;
        font-weight: 700;
    }

    .button-group .btn-secondary {
        background-color: #e8e8e8;
        color: #333;
    }

    .button-group .btn:focus-visible {
        outline: none;
        box-shadow: 0 0 0 3px rgba(26, 42, 94, 0.2);
    }

    input.error,
    select.error {
        border-color: #e74c3c;
    }

    input[type="text"]:disabled,
    input[type="number"]:disabled {
        background-color: #ececec;
        color: #666;
        border-color: #d0d0d0;
        cursor: not-allowed;
    }

    .success-container {
        text-align: center;
        padding: 40px 28px;
        background-color: white;
        border-radius: 14px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .success-icon {
        width: 60px;
        height: 60px;
        background-color: #28a745;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        color: white;
        font-size: 2em;
    }

    .success-text {
        color: #1a2a5e;
        font-size: 1.1em;
        line-height: 1.6;
        margin: 0 auto 30px;
        max-width: 480px;
    }

    .success-container .btn {
        min-width: 200px;
        min-height: 46px;
        border-radius: 12px;
        font-size: 0.96em;
        font-weight: 700;
    }
{% endblock %}

{% block content %}
    <!-- Main Content -->
    <div class="form-container">
        <div class="form-card">
            {% if success %}
                <!-- Success State -->
                <div class="success-container">
                    <div class="success-icon">âœ“</div>
                    <p class="success-text">Property information updated successfully.</p>
                    <a href="{% url 'property_list' %}" class="btn btn-primary">Back to Properties</a>
                </div>
            {% else %}
                <!-- Form -->
                <h1>Update Property</h1>

                <form id="propertyForm" method="POST">
                    {% csrf_token %}

                    {% if errors.general %}
                        <div style="color: #e74c3c; margin-bottom: 20px; text-align: center;">{{ errors.general }}</div>
                    {% endif %}

                    <!-- Property ID (Read-only) -->
                    <div class="form-row">
                        <div>
                            <label for="property_id">Property ID</label>
                            <input 
                                type="text" 
                                id="property_id"
                                value="{{ property.id }}"
                                disabled
                            >
                        </div>
                        <div>
                            <label for="property_name">Property Name</label>
                            <input 
                                type="text" 
                                id="property_name" 
                                name="property_name" 
                                placeholder="XX Dolor St., Sit Amet"
                                value="{{ form_data.property_name }}"
                                {% if errors.property_name %}class="error"{% endif %}
                            >
                            {% if errors.property_name %}<span class="error-message">{{ errors.property_name }}</span>{% endif %}
                        </div>
                    </div>

                    <!-- Property Address -->

                    <div class="form-row">
                        <div>
                            <label for="street_number">Street/Unit No.</label>
                            <input 
                                type="text" 
                                id="street_number" 
                                name="street_number"
                                value="{{ form_data.street_number }}"
                                {% if errors.street_number %}class="error"{% endif %}
                            >
                            {% if errors.street_number %}<span class="error-message">{{ errors.street_number }}</span>{% endif %}
                        </div>
                        <div>
                            <label for="street">Street</label>
                            <input 
                                type="text" 
                                id="street" 
                                name="street"
                                value="{{ form_data.street }}"
                                {% if errors.street %}class="error"{% endif %}
                            >
                            {% if errors.street %}<span class="error-message">{{ errors.street }}</span>{% endif %}
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label for="city">City</label>
                            <input 
                                type="text" 
                                id="city" 
                                name="city"
                                value="{{ form_data.city }}"
                                {% if errors.city %}class="error"{% endif %}
                            >
                            {% if errors.city %}<span class="error-message">{{ errors.city }}</span>{% endif %}
                        </div>
                        <div>
                            <label for="province">Province</label>
                            <input 
                                type="text" 
                                id="province" 
                                name="province"
                                value="{{ form_data.province }}"
                                {% if errors.province %}class="error"{% endif %}
                            >
                            {% if errors.province %}<span class="error-message">{{ errors.province }}</span>{% endif %}
                        </div>
                    </div>

                    <div class="form-row">
                        <div>
                            <label for="zip_code">Zip Code</label>
                            <input 
                                type="text" 
                                id="zip_code" 
                                name="zip_code"
                                value="{{ form_data.zip_code }}"
                                {% if errors.zip_code %}class="error"{% endif %}
                            >
                            {% if errors.zip_code %}<span class="error-message">{{ errors.zip_code }}</span>{% endif %}
                        </div>
                        <div>
                            <label for="country">Country</label>
                            <input 
                                type="text" 
                                id="country" 
                                name="country"
                                value="{{ form_data.country }}"
                                {% if errors.country %}class="error"{% endif %}
                            >
                            {% if errors.country %}<span class="error-message">{{ errors.country }}</span>{% endif %}
                        </div>
                    </div>

                    <!-- Type of Property -->
                    <div class="form-group form-row full">
                        <div>
                            <label for="property_type">Type of Property</label>
                            <select 
                                id="property_type" 
                                name="property_type"
                                {% if errors.property_type %}class="error"{% endif %}
                            >
                                <option value="">Select Property Type</option>
                                <option value="Residential" {% if form_data.property_type == 'Residential' %}selected{% endif %}>Residential</option>
                                <option value="Commercial" {% if form_data.property_type == 'Commercial' %}selected{% endif %}>Commercial</option>
                                <option value="Industrial" {% if form_data.property_type == 'Industrial' %}selected{% endif %}>Industrial</option>
                                <option value="Agricultural" {% if form_data.property_type == 'Agricultural' %}selected{% endif %}>Agricultural</option>
                                <option value="Mixed Use" {% if form_data.property_type == 'Mixed Use' %}selected{% endif %}>Mixed Use</option>
                            </select>
                            {% if errors.property_type %}<span class="error-message">{{ errors.property_type }}</span>{% endif %}
                        </div>
                    </div>

                    <!-- Floor Area -->
                    <div class="form-group form-row full">
                        <div>
                            <label for="floor_area">Floor Area (in sqm)</label>
                            <input 
                                type="number" 
                                id="floor_area" 
                                name="floor_area"
                                step="0.01"
                                placeholder="XXX"
                                value="{{ form_data.floor_area }}"
                                min="0"
                                required
                                {% if errors.floor_area %}class="error"{% endif %}
                            >
                            {% if errors.floor_area %}<span class="error-message">{{ errors.floor_area }}</span>{% endif %}
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" onclick="openCancelModal()">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="openConfirmModal()">Update Information</button>
                    </div>
                </form>
            {% endif %}
        </div>
    </div>

    <!-- Cancel Confirmation Modal -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <h2>Cancel Update?</h2>
            <p>Are you sure you want to cancel? Your changes will not be saved.</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeCancelModal()">Continue Editing</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmCancel()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Update Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2>Update Property Information?</h2>
            <p>Please review your property information before confirming the update.</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeConfirmModal()">Continue Editing</button>
                <button class="modal-btn modal-btn-confirm" onclick="submitForm()">Confirm</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
        function openCancelModal() {
            document.getElementById('cancelModal').classList.add('show');
        }

        function closeCancelModal() {
            document.getElementById('cancelModal').classList.remove('show');
        }

        function confirmCancel() {
            window.location.href = "{% url 'property_list' %}";
        }

        function openConfirmModal() {
            // Validate form before showing modal
            const form = document.getElementById('propertyForm');
            const inputs = form.querySelectorAll('input[type="text"]:not([disabled]), input[type="number"], select');
            let allFilled = true;

            inputs.forEach(input => {
                if (!input.value.trim()) {
                    allFilled = false;
                    input.classList.add('error');
                } else {
                    input.classList.remove('error');
                }
            });

            if (allFilled) {
                document.getElementById('confirmModal').classList.add('show');
            } else {
                alert('Please fill in all required fields.');
            }
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('show');
        }

        function submitForm() {
            document.getElementById('propertyForm').submit();
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const cancelModal = document.getElementById('cancelModal');
            const confirmModal = document.getElementById('confirmModal');
            
            if (event.target === cancelModal) {
                closeCancelModal();
            }
            if (event.target === confirmModal) {
                closeConfirmModal();
            }
        });

        // Clear error messages when user interacts with form fields
        const formInputs = document.querySelectorAll('input, select, textarea');
        formInputs.forEach(input => {
            input.addEventListener('focus', function() {
                clearErrorMessage(this);
            });
            input.addEventListener('change', function() {
                clearErrorMessage(this);
            });
        });

        function clearErrorMessage(field) {
            // Remove error class from the input
            field.classList.remove('error');
            
            // Find and hide error message - look through parent and siblings
            let parent = field.parentElement;
            while (parent) {
                const errorSpan = parent.querySelector('.error-message');
                if (errorSpan) {
                    errorSpan.style.visibility = 'hidden';
                    errorSpan.style.height = '0';
                    errorSpan.style.margin = '0';
                    errorSpan.style.padding = '0';
                    break;
                }
                parent = parent.parentElement;
            }
        }
    </script>
{% endblock %}
